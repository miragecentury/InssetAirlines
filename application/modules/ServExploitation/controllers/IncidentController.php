<?php

class ServExploitation_IncidentController extends Zend_Controller_Action
{

    public function init()
    {
        $this->view->setLfiProtection(false);
        $this->view->render('../../../../views/scripts/user/_sidebar.phtml');
        $this->view->render('../../../../views/scripts/user/_login.phtml');
        $this->view->render('sidebar/_homeIncidentSidebar.phtml');


        $this->_acl = Zend_Registry::get('Acl');
        //ACL
        $authSession = new Zend_Session_Namespace('Zend_Auth');
        if (!$this->_acl->isAllowed($authSession->role, 'Mod_Serv_Exp')) {
            $session = new Zend_Session_Namespace('Redirect');
            $session->message = "Vous n'avez pas les droits pour acceder à ce service";
            $session->redirection = "/";
            $this->_redirect(Zend_Registry::get('BaseUrl') . '/redirection/fail');
        }
    }

    public function indexAction()
    {
        $this->view->all = ServExploitation_Model_Incident::getListeIncident();
    }

    public function newAction()
    {
        $this->view->render('sidebar/_homeIncidentAdminSidebar.phtml');
        $form = new ServExploitation_Form_Incident();
        $session = new Zend_Session_Namespace('Redirect');
        if (empty($_POST) || !$form->isValid($_POST)) {
            $this->view->form = $form;
            $this->view->vol = ServPlaning_Model_Vol::getVolsDuJour();
        } else {
            if (ServPlaning_Model_Vol::getVol($noVol) instanceof Serv_Planing_Vol){
                $item = new ServExploitation_Model_Incident();
                $item->set_dateIncident($form->getValue('dateIncident'))
                        ->set_noAeroportArriNextIncident($form->getValue('noAeroportArriNextIncident'))
                        ->set_noVol($form->getValue('noVol'))
                        ->set_idTypeIncident($form->getValue('idTypeIncident'));
                $item->addIncident();

                $session->message = "Ajout du type d'incident réussi.";
                $session->redirection = "/ServExploitation/Incident/admin";
                $this->_redirect(Zend_Registry::get('BaseUrl') . '/redirection/success');
            } else {
                $session->message = "Le vol n'existe pas !";
                $session->redirection = "/ServExploitation/Incident/admin";
                $this->_redirect(Zend_Registry::get('BaseUrl') . '/redirection/fail');
            }
        } 
    }

    public function updAction()
    {
        $this->view->render('sidebar/_homeIncidentAdminSidebar.phtml');
        $form = new ServExploitation_Form_Incident();
        $item = new ServExploitation_Model_Incident();
        if (empty($_POST) || !$form->isValid($_POST)) {
            $item = $item->getIncident($this->getRequest()->getParam('id'));
            if ($item != null) {
                $form->getElement('dateIncident')->setValue($item->get_dateIncident());
                $form->getElement('noAeroportArriNextIncident')->setValue($item->get_noAeroportArriNextIncident());
                $form->getElement('noVol')->setValue($item->get_noVol());
                $form->getElement('idTypeIncident')->setValue($item->get_idTypeIncident());
            }
            $this->view->form = $form;
            $this->view->vol = ServPlaning_Model_Vol::getVolsDuJour();
        } else {
            $item->set_noIncident($this->getRequest()->getParam('id'))
                    ->set_dateIncident($form->getValue('dateIncident'))
                    ->set_noAeroportArriNextIncident($form->getValue('noAeroportArriNextIncident'))
                    ->set_noVol($form->getValue('noVol'))
                    ->set_idTypeIncident($form->getValue('idTypeIncident'));
            $item->addIncident();
            $session = new Zend_Session_Namespace('Redirect');
            $session->message = "Modification réussi.";
            $session->redirection = "/ServExploitation/Incident/admin";
            $this->_redirect(Zend_Registry::get('BaseUrl') . '/redirection/success');
        }
    }

    public function delAction()
    {
        $this->view->render('sidebar/_homeIncidentAdminSidebar.phtml');
        $Mod = new ServExploitation_Model_Incident;
        $request = $this->getRequest();
        $session = new Zend_Session_Namespace('Redirect');
        $session->redirection = "/ServExploitation/Incident/admin";
        $item = $Mod->getIncident($request->getParam('id'));
        if ($request->getParam('ok') === "ok") {
            if ($item != null) {
                $Mod->delIncident($request->getParam('id'));
                $session->message = "Supression réussi.";
                $this->_redirect(Zend_Registry::get('BaseUrl') . '/redirection/success');
            } else {
                Zend_Registry::get('Log')->log('IncidentController : del : Acces a la base de donnée impossible', Zend_Log::ALERT);
                $session->message = "Echec de supression.";
                $this->_redirect(Zend_Registry::get('BaseUrl') . '/redirection/fail');
            }
        } else {
            $this->view->item = $item;
            $this->view->id = $request->getParam('id');
        }
    }

    public function detailAction()
    {
        $this->view->render('sidebar/_homeIncidentAdminSidebar.phtml');
        $Mod = new ServExploitation_Model_Incident;
        $this->view->item = $Mod->getIncident($this->getRequest()->getParam('id'));
        $this->view->id = $this->getRequest()->getParam('id');
    }

    public function adminAction()
    {
        $this->view->render('sidebar/_homeIncidentAdminSidebar.phtml');
        $this->view->all = ServExploitation_Model_Incident::getListeIncident();
    }

}