<?php

class ServExploitation_IncidentController extends Zend_Controller_Action
{

    public function init()
    {
        $this->view->setLfiProtection(false);
        $this->view->render('../../../../views/scripts/user/_sidebar.phtml');
        $this->view->render('../../../../views/scripts/user/_login.phtml');
    }

    public function indexAction()
    {
        try {
            $all = ServExploitation_Model_Incident::getListeIncidentHTML(false);
        } catch (Zend_Exception $e) {
            Zend_Registry::get('Log')->log('IncidentController : index : Acces a la base de donnée impossible', Zend_Log::ALERT);
            return FALSE;
        }
        if ($all != null)
            $this->view->all = $all;
        else
            $this->view->all = "Erreur dans la base de donnée, 
                veuillez contacter l'administrateur du site via le 
                formulaire de contact.<br/>";
    }

    public function newAction()
    {
        $request = $this->getRequest();
        if ($request->getParam('submit') != "Valider") {
            $form = new ServExploitation_Form_Incident();
            $this->view->form = $form;
        } else {
            $item = new ServExploitation_Model_Incident();
            $item->set_dateIncident($request->getParam('dateIncident'))
                    ->set_noAeroportArriNextIncident($request->getParam('noAeroportArriNextIncident'))
                    ->set_noVol($request->getParam('noVol'))
                    ->set_idTypeIncident($request->getParam('idTypeIncident'));
            try {
                $item->addIncident();
            } catch (Zend_Exception $e) {
                Zend_Registry::get('Log')->log('IncidentController : new : Acces a la base de donnée impossible', Zend_Log::ALERT);
                return FALSE;
            }
            $this->_redirect('ServExploitation/Incident/admin');
        }
    }

    public function updAction()
    {
        $request = $this->getRequest();
        if ($request->getParam('submit') != "Valider") {
            $item = new ServExploitation_Model_Incident();
            try {
                $item = $item->getIncident($request->getParam('id'));
            } catch (Zend_Exception $e) {
                Zend_Registry::get('Log')->log('IncidentController : upd : Acces a la base de donnée impossible', Zend_Log::ALERT);
                return FALSE;
            }
            $form = new ServExploitation_Form_Incident();
            if ($item != null) {
                $form->getElement('dateIncident')->setValue($item->get_dateIncident());
                $form->getElement('noAeroportArriNextIncident')->setValue($item->get_noAeroportArriNextIncident());
                $form->getElement('noVol')->setValue($item->get_noVol());
                $form->getElement('idTypeIncident')->setValue($item->get_idTypeIncident());
            }
            $this->view->form = $form;
        } else {
            $item = new ServExploitation_Model_Incident();
            $item->set_noIncident($request->getParam('id'))
                    ->set_dateIncident($request->getParam('dateIncident'))
                    ->set_noAeroportArriNextIncident($request->getParam('noAeroportArriNextIncident'))
                    ->set_noVol($request->getParam('noVol'))
                    ->set_idTypeIncident($request->getParam('idTypeIncident'));
            try {
                $item->addIncident();
            } catch (Zend_Exception $e) {
                Zend_Registry::get('Log')->log('IncidentController : upd : Acces a la base de donnée impossible', Zend_Log::ALERT);
                return FALSE;
            }
            $this->_redirect('ServExploitation/Incident/admin');
        }
    }

    public function delAction()
    {
        $request = $this->getRequest();
        $Mod = new ServExploitation_Model_Incident;
        if ($request->getParam('ok') === "ok") {
            try {
                $Mod->delIncident($request->getParam('id'));
            } catch (Zend_Exception $e) {
                Zend_Registry::get('Log')->log('IncidentController : del : Acces a la base de donnée impossible', Zend_Log::ALERT);
                return FALSE;
            }
            $this->_redirect('ServExploitation/Incident/admin');
        } else {
            try {
                $item = $Mod->getIncident($request->getParam('id'));
            } catch (Zend_Exception $e) {
                Zend_Registry::get('Log')->log('IncidentController : del : Acces a la base de donnée impossible', Zend_Log::ALERT);
                return FALSE;
            }
            if ($item != null) {
                $this->view->item = $item->getIncidentHTML();
            } else {
                $this->view->item = "Cet Incident n'existe pas dans la base de donnée!<br/>";
            }
            $this->view->id = $request->getParam('id');
        }
    }

    public function detailAction()
    {
        $Mod = new ServExploitation_Model_Incident;
        try {
            $item = $Mod->getIncident($this->getRequest()->getParam('id'));
        } catch (Zend_Exception $e) {
            Zend_Registry::get('Log')->log('IncidentController : detail : Acces a la base de donnée impossible', Zend_Log::ALERT);
            return FALSE;
        }
        if ($item != null) {
            $this->view->item = $item->getIncidentHTML();
        } else {
            $this->view->item = "Cet Incident n'existe pas dans la base de donnée!<br/>";
        }
        $this->view->id = $this->getRequest()->getParam('id');
    }

    public function adminAction()
    {
        try {
            $all = ServExploitation_Model_Incident::getListeIncidentHTML();
        } catch (Zend_Exception $e) {
            Zend_Registry::get('Log')->log('IncidentController : admin : Acces a la base de donnée impossible', Zend_Log::ALERT);
            return FALSE;
        }
        if ($all != null)
            $this->view->all = $all;
        else
            $this->view->all = "Erreur dans la base de donnée, 
                veuillez contacter l'administrateur du site via 
                le formulaire de contact.<br/>";
    }

}